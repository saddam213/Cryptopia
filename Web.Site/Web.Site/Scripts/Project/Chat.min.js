function ChatModule(n){function c(){e?f():postJson("/Chat/GetChatHistory",{},function(n){if(n.data)for(u.empty(),i=0;i<n.data.length;i++)l(n.data[i]);$(".chat-messages tr td").each(function(){$(this).find("small").each(function(){$(this).html(a(new Date(n.time),new Date($(this).data("val"))))})});f();e=!0})}function f(){var t=$(n).find(".chat-container");t&&t[0]&&t.scrollTop(t[0].scrollHeight)}function w(){var t=$(n).find(".chat-container");return t&&t[0]&&t.scrollTop()+70>=t[0].scrollHeight-t.innerHeight()?!0:!1}function l(n){var t=n.UserName==authenticatedUserName;if(n.IsBot)u.append(Mustache.render(v,{Id:n.Id,UserName:n.UserName,ChatHandle:n.ChatHandle,Message:emotify(n.Message.linkify()),IsAdmin:authenticatedAdmin=="True"?"":"none",IsMine:n.ChatHandle==authenticatedChatHandle||authenticated=="False"?"none":""}));else if(n.IsTipBot)u.append(Mustache.render(p,{Id:n.Id,UserName:n.UserName,ChatHandle:n.ChatHandle,Message:emotify(n.Message.linkify()),IsAdmin:authenticatedAdmin=="True"?"":"none",IsMine:n.ChatHandle==authenticatedChatHandle||authenticated=="False"?"none":""}));else{var i="@"+authenticatedChatHandle+",",r=n.Message.indexOf(i)>-1,f=b(n.Flair);u.append(Mustache.render(y,{Id:n.Id,UserName:n.UserName,ChatHandle:n.ChatHandle,Flair:f,KarmaTotal:n.KarmaTotal,Timestamp:n.Timestamp,Avatar:n.Avatar,Message:emotify(n.Message.linkify()),Highlight:r?"chat-highlight-usertouser":"",IsAdmin:authenticatedAdmin=="True"?"":"none",IsMine:t||authenticated=="False"?"none":""}))}}function b(n){var i="",t;if(n)for(t=n.split("|"),k=0;k<t.length;k++)i+='<i style="padding-right:2px" class="'+t[k]+'" ><\/i>';return i}function a(n,t){var i,r=Math.floor((n-t)/1e3);return r<60?(i=Math.floor(r),i>3)?String.format(Resources.Chat.SinceSecondsLabel,Math.floor(r)):Resources.Chat.SinceSecondLabel:r<3600?(i=Math.floor(r/60),i>2)?String.format(Resources.Chat.SinceMinutesLabel,i):Resources.Chat.SinceMinuteLabel:r<86400?(i=Math.floor(r/3600),i>1)?String.format(Resources.Chat.SinceHoursLabel,i):Resources.Chat.SinceHourLabel:Resources.Chat.SinceAgesLabel}var r,t=this,h=null,e=!1,o=!1,u=$(n).find(".chat-messages tbody"),v=$("#chatBotTemplate").html(),y=$("#chatUserTemplate").html(),p=$("#chatTipbotTemplate").html(),s;this.initializeChat=function(){o?c():$.getJSON("/Chat/EmoticonSet",function(n){var r={},i,t;for(i in n)n.hasOwnProperty(i)&&(t=n[i],r[t.Code]=[t.Path,t.Name]);emotify.emoticons(cdnImagePath+"/Content/Images/Emoticonset/",r);o=!0;c()});r?t.getOnlineCount():($.connection.hub.stop(),r=$.connection.chatHub,r.client.broadcastMessage=function(n){var t=w();l(n);t==!0&&f()},r.client.broadcastRemoval=function(n){$(".chat-messages tbody > tr.chat-msgid-"+n).remove()},r.client.broadcastOnlineCount=function(n,t){$(".chat-messages tr").each(function(){$(this).find("small").each(function(){$(this).html(a(new Date(t),new Date($(this).data("val"))))})});$(".chat-online-count").html(n)},$.connection.hub.start({transport:["webSockets"]}).done(function(){clearInterval(s);s=setInterval(function(){t.getOnlineCount()},3e4);t.getOnlineCount()}))};this.detroy=function(){clearInterval(s)};this.refreshPopout=function(){settings="width=480, height=640, scrollbars=no, location=no, directories=no, status=no, menubar=no, toolbar=no, resizable=yes, dependent=no";h=window.open("/Chat/Index","Trollbox",settings);h.focus()};this.reload=function(){e=!1;o=!1;t.initializeChat()};this.sendChatMessage=function(t){var i=$(n).find(".chat-message"),r=i.val();r.length!==0&&(postJson("/Chat/SendChatMessage",{message:r}),i.val("").focus(),t&&f())};this.removeChatPost=function(n){confirm(Resources.Chat.RemovePostQuestionTitle,Resources.Chat.RemovePostQuestion,function(){postJson("/Chat/RemoveChatPost",{chatId:n})})};this.getOnlineCount=function(){postJson("/Chat/GetOnlineCount")};this.banChatUser=function(n){openModalGet("/Chat/BanChatUser",{chathandle:n})};this.ignoreChatUser=function(n){getJson("/UserSettings/SubmitChatIgnore",{username:n},function(n){notify(Resources.Chat.IgnoreNotificationTitle,n.Message)})};this.tipCurrency=function(){openModal("/Balance/TipCurrency",Resources.General.LoadingMessage,{},function(){})};this.ignoreTipUser=function(n){getJson("/UserSettings/SubmitTipIgnore",{username:n},function(n){notify(Resources.Chat.TipIgnoreNotificationTitle,n.Message)})};this.sendChatKarma=function(n,t){getJson("/Karma/SubmitChatKarma",{chatHandle:n,chatMessageId:t},function(n){var t=htmlEncode(n.Message);n.Success&&$(".karma-"+n.User).html(n.Count);sendNotification(Resources.Chat.SendKarmaNotificationTitle,t,n.Success?0:2)})};this.sendTipKarma=function(n,t){getJson("/Karma/SubmitTipKarma",{chatHandle:n,chatMessageId:t},function(n){var t=htmlEncode(n.Message);n.Success&&$(".karma-"+n.User).html(n.Count);sendNotification(Resources.Chat.TipKarmaNotificationTitle,t,n.Success?0:2)})};this.emoticonPicker=function(){openModalGet("/Chat/Emoticons")};$(n).on("click",".chat-send",function(){t.sendChatMessage(!0)});$(n).on("keyup",".chat-message",function(n){if(n.keyCode==13&&!n.shiftKey)return t.sendChatMessage(!0),!1});$(n).on("click",".chat-item-username",function(){var t=$(n).find(".chat-message");t&&(t.val(t.val()+"@"+$(this).text()+", "),t.focus(),t.caretToEnd())});$(n).on("click",".chat-remove-message",function(){t.removeChatPost($(this).data("messageid"))});$(n).on("click",".chat-karma-message",function(){var n=$(this).data("user"),i=$(this).data("messageid");t.sendChatKarma(n,i)});$(n).on("click",".chat-karma-tip",function(){var n=$(this).data("user"),i=$(this).data("messageid");t.sendTipKarma(n,i)});$(n).on("click",".chat-ban-user",function(){var n=$(this).data("user");t.banChatUser(n)});$(n).on("click",".chat-ignore-user",function(){var n=$(this).data("user");t.ignoreChatUser(n)});$(n).on("click",".chat-ignore-tip",function(){var n=$(this).data("user");t.ignoreTipUser(n)});$(n).on("click",".chat-option-tip",function(){t.tipCurrency()});$(n).on("click",".chat-option-emoticons",function(){t.emoticonPicker()});$(n).on("click",".chat-refresh, .chat-popout",function(){t.refreshPopout()})}